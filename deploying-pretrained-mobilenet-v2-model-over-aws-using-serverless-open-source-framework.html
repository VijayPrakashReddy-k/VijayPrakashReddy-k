<!DOCTYPE HTML>
<!--
    Striped by HTML5 UP
    html5up.net | @n33co
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
  -->
<html lang="en">
    <head>
        <title>Deploying pretrained MobileNet V2 model over AWS using serverless open source framework</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <!--[if lte IE 8]><script src="./theme/assets/js/ie/html5shiv.js"></script><![endif]-->
        <link rel="stylesheet" href="./theme/assets/css/main.css" />
        <link rel="stylesheet" href="./theme/assets/css/pygment-default.css" />
        <!--[if lte IE 8]><link rel="stylesheet" href="./theme/assets/css/ie8.css" /><![endif]-->

<meta name="tags" content="mobilenet v2" />
<meta name="tags" content="classification" />
<meta name="tags" content="Aws lambda" />
<meta name="tags" content="Imagenet" />
    </head>
    <body>

        <!-- Content -->
        <div id="content">
            <div class="inner">
<article class="box post post-excerpt">
    <header>
        <h2><a href="./deploying-pretrained-mobilenet-v2-model-over-aws-using-serverless-open-source-framework.html" rel="bookmark">Deploying pretrained MobileNet V2 model over AWS using serverless open source framework</a></h2>
        <address class="author">
            By             <a href="./author/vijayprakash.html">Vijayprakash</a>
        </address>
        <div>
           <i class="fa fa-folder"></i>&nbsp;<a class="folder" href="./category/eva.html">EVA</a>
<i class="fa fa-tags"></i>&nbsp;<span class="tag"><a href="./tag/mobilenet-v2.html">mobilenet v2</a></span> <span class="tag"><a href="./tag/classification.html">classification</a></span> <span class="tag"><a href="./tag/aws-lambda.html">Aws lambda</a></span> <span class="tag"><a href="./tag/imagenet.html">Imagenet</a></span>         </div>
    </header>
    <div class="info">
        <!--
            Note: The date should be formatted exactly as it's shown below. In particular, the
            "least significant" characters of the month should be encapsulated in a <span>
            element to denote what gets dropped in 1200px mode (eg. the "uary" in "January").
            Oh, and if you don't need a date for a particular page or post you can simply delete
            the entire "date" element.
          -->
        <time class="published" datetime="2021-02-02T00:00:00+05:30">
            <span class="date"><span class="month">Feb</span> <span class="day">02</span><span class="year"><span>, </span>2021</span></span>
        </time>
        <ul class="stats">
            <!--
            <li><a href="#" class="icon fa-heart">32</a></li>
            <li><a href="#" class="icon fa-twitter">64</a></li>
            <li><a href="#" class="icon fa-facebook">128</a></li>
            -->
        </ul>
    </div>
    <p align = 'center'>
    <img src = "images/mobilenet_v2.png" alt="mobilenet v2" />
</p>

<p><code>Deploying pretrained mobilnet V2 model on Imagenet, using serverless open source framework to build and run application on AWS Lambda and fetch model from s3 bucket.</code><br>
<code>Serverless framwork manages all the resources in AWS and user need to just focus on the Application and problem solving.All the AWS resocures such as</code> <strong>API end point, Lambda functions, Cloud Formations, application packages on S3</strong>  <code>and many mores resources are created automatically.</code></p>
<div class="row gtr-uniform">
      <div class="col-3 col-12-xsmall">
        <ul class="actions">
          <li><input type="file" id="imageUpload"></li>
        </ul>
        <ul class="actions">
          <li><input type="button" style="margin-top: 15px;" id="button" value="classify"></li>
        </ul>
      </div>
      <div class="col-9">
        <span class="image fit">
          <img id="output" height="300px">
    </span>
    </div>
</div>

<p><i>"Due to cold start of Lambda, if it's taking more than a minute for first run, give a second try after 90 seconds by changing image"<i></p>

<div style="text-align:center;margin-top: 25px;">

    <h3 id="mobilenet_imagenet">MobileNet V2 (ImageNet 1000 Classes)</h3>
</div>

<script>
var files;

document.getElementById('imageUpload').onchange = function (evt) {
    files = event.target.files;
    var reader = new FileReader();
    reader.onload = function(){
      var dataURL = reader.result;
      var output = document.getElementById('output');
      output.src = dataURL;
    };
    reader.readAsDataURL(files[0]);

}

  document.getElementById('button').onclick = function (evt) {

  const formData = new FormData ();
  formData.append ("data", files[0]);
  console.log (files[0]);
  document.getElementById("mobilenet_imagenet").innerHTML = "Fetching results..."
  fetch("https://f22saolkw5.execute-api.ap-south-1.amazonaws.com/dev/mobilenetV2-classify", {
    method: "POST",
    body: formData,
  })
.then(response => response.json())
.then(json => {
 console.log (json);
      if (json.error) {
        document.getElementById("mobilenet_imagenet").innerHTML = "<h3>" + "Class Not Found" + "</h3>";
      } else {
        document.getElementById("mobilenet_imagenet").innerHTML = "<h3 id='imgClass' style='text-align:center'> " + json.predicted +"</h3>";
      }
   });

};
</script>

<p><strong>Context:</strong></p>
<p><em><code>It's a Series of learning on Training models for less configurable devices like Mobiles, Embedded Systems (Jetson Nano, Rasberry pi, Neural computing stick) with less number of parameters without compromising the Accuracy.Here, in the first article mainly focusing on setting up environment and deploying into AWS.</code></em></p>
<p>Pre-Requisite:</p>
<div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">OS</span><span class="p">:</span> <span class="n">Ubuntu</span> <span class="mi">18</span><span class="p">.</span><span class="mi">04</span><span class="o">/</span><span class="mi">20</span><span class="p">.</span><span class="mi">04</span>

<span class="o">-</span> <span class="n">Miniconda</span> <span class="n">environment</span> <span class="k">with</span> <span class="n">necessary</span> <span class="n">python</span> <span class="n">package</span>

<span class="o">-</span> <span class="n">Install</span> <span class="n">Docker</span> <span class="k">and</span> <span class="n">Node</span><span class="p">.</span><span class="n">js</span>

<span class="o">-</span> <span class="n">Install</span> <span class="k">open</span> <span class="k">source</span> <span class="n">packages</span><span class="p">,</span> <span class="n">npm</span> <span class="k">and</span> <span class="n">serverless</span><span class="p">.</span>

<span class="o">-</span> <span class="n">setup</span> <span class="n">AWS</span> <span class="n">account</span> <span class="k">for</span> <span class="mi">1</span> <span class="k">year</span> <span class="k">free</span> <span class="n">subscription</span> <span class="k">by</span> <span class="n">providing</span> <span class="n">credit</span> <span class="n">card</span> <span class="n">details</span><span class="p">.</span>
</pre></div>


<p><strong>Content:</strong></p>
<ul>
<li>Get a pre-trained model, mobilenet v2 trained on Imagenet and deploy it into AWS S3(Simple Storage Service) bucket.</li>
</ul>
<p align = 'center'>
    <img src = "images/mobilenet_v2(pretrained)2.png" alt="model" />
</p>

<div class="highlight"><pre><span></span><span class="c1">### Importing the Libraries</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">models</span>

<span class="c1">### Instancing a pre-trained model will download it&#39;s weights to a cache memory</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">mobilenet_v2</span><span class="p">(</span><span class="n">pretrained</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1">### Deactivating some layers in the model, so that model output it&#39;s inferences as expected.</span>
<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

<span class="c1">### Trace the model with some dummy input</span>
<span class="n">traced_model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">224</span><span class="p">,</span><span class="mi">224</span><span class="p">))</span>

<span class="c1">### Saving the model</span>
<span class="n">traced_model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;mobilenet_v2.pt&#39;</span><span class="p">)</span>
</pre></div>


<ul>
<li>Create a serverless Lambda(service) function. It generates boilerplate for template: aws-python3</li>
</ul>
<p align = 'center'>
    <img src = "images/sls setup.png" alt="sls setup" />
</p>

<div class="highlight"><pre><span></span><span class="c1">### Setting up serverless(sls) with the AWS user credentials</span>
<span class="n">sudo</span> <span class="n">sls</span> <span class="n">config</span> <span class="n">credentials</span> <span class="o">--</span><span class="n">provider</span> <span class="n">aws</span> <span class="o">--</span><span class="n">key</span> <span class="o">&lt;</span><span class="n">AWS</span><span class="o">-</span><span class="n">key</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">secret</span> <span class="o">&lt;</span><span class="n">AWS</span><span class="o">-</span><span class="n">secret</span><span class="o">-</span><span class="n">key</span><span class="o">&gt;</span>

<span class="c1">### Create a service (Lambda function) in current directory with service name as new folder.</span>
<span class="c1">#serverless create --template &lt;name-of-the-template&gt; --path &lt;name-of-the-service&gt;</span>
<span class="n">sudo</span> <span class="n">serverless</span> <span class="n">create</span> <span class="o">--</span><span class="n">template</span> <span class="n">aws</span><span class="o">-</span><span class="n">python3</span> <span class="o">--</span><span class="n">path</span> <span class="n">mobilenet</span><span class="o">-</span><span class="n">v2</span>
</pre></div>


<p><em><code>After creating a Lambda function, it will generate a folder which is having two files i.e., handler.py and config.yml files with service name as folder name.</code></em></p>
<ul>
<li>Installing a serverless plugin which will automatically bundle dependencies from a requirement.txt file.</li>
</ul>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">serverless</span> <span class="n">plugin</span> <span class="n">install</span> <span class="o">-</span><span class="n">n</span> <span class="n">serverless</span><span class="o">-</span><span class="n">python</span><span class="o">-</span><span class="n">requirements</span>
</pre></div>


<p><strong><code>Change the permission of lambda function folder, run below command inside the folder (mobilenet-v2).if used sudo while creating it.</code></strong></p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="err">$</span><span class="n">USER</span><span class="p">:</span><span class="err">$</span><span class="n">USER</span> <span class="o">.</span>
</pre></div>


<ul>
<li><code>Deployment Package on AWS Lambda cannot be greater than 250MB (Pytorch itself can be 470MB or more!). so manually create requirements.txt file and add a link to python wheel file (.whl) for Pytorch and Lambda will directly install it for us. The requirements.txt should look like below:</code></li>
</ul>
<p align = 'center'>
    <img src = "images/requirements.png" alt="requirements file" />
</p>

<ul>
<li>To enable deploying package through npm command, add a deploy script to package.json file </li>
</ul>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;mobilenet-v2&quot;</span><span class="p">,</span>
  <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
  <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;0.1.0&quot;</span><span class="p">,</span>
  <span class="nt">&quot;dependencies&quot;</span><span class="p">:</span> <span class="p">{},</span>
  <span class="nt">&quot;scipts&quot;</span><span class="p">:{</span><span class="nt">&quot;deploy&quot;</span><span class="p">:</span><span class="s2">&quot;serverless deploy&quot;</span><span class="p">},</span>
  <span class="nt">&quot;devDependencies&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;serverless-python-requirements&quot;</span><span class="p">:</span> <span class="s2">&quot;^5.1.0&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<ul>
<li>Update handler function in handler.py</li>
</ul>
<div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Code to download pre-trained pytorch model.</span>
<span class="sd">Download the pre-trained model and convert into trace model</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">unzip_requirements</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="kn">from</span> <span class="nn">requests_toolbelt.multipart</span> <span class="kn">import</span> <span class="n">decoder</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torchvision</span>
<span class="kn">import</span> <span class="nn">torchvision.transforms</span> <span class="k">as</span> <span class="nn">transforms</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="kn">from</span> <span class="nn">torchvision.models</span> <span class="kn">import</span> <span class="n">resnet50</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>

<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tarfile</span>  
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Import End&quot;</span><span class="p">)</span>

<span class="c1"># define environmental variables if there are not existing</span>
<span class="n">S3_BUCKET</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;S3_BUCKET&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;S3_BUCKET&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="k">else</span> <span class="s1">&#39;name-of-the-bucket&#39;</span>
<span class="n">MODEL_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MODEL_PATH&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;MODEL_PATH&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="k">else</span> <span class="s1">&#39;mobilenet_v2.pt&#39;</span>
<span class="n">json_data</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;json_data&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;json_data&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="k">else</span> <span class="s1">&#39;imagenet1000_clsidx_to_labels.json&#39;</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading the model:&quot;</span><span class="p">)</span>

<span class="n">s3</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">MODEL_PATH</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1">#get object from s3</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="n">S3_BUCKET</span><span class="p">)</span><span class="o">.</span><span class="n">Object</span><span class="p">(</span><span class="n">MODEL_PATH</span><span class="p">)</span>
        <span class="c1"># read it in memory</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;creating Bytestream&quot;</span><span class="p">)</span>
        <span class="n">bytestream</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">()[</span><span class="s1">&#39;Body&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading Model&quot;</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">bytestream</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model loaded&quot;</span><span class="p">)</span>

<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="k">raise</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">transform_image</span><span class="p">(</span><span class="n">image_bytes</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Transform the image for pre-trained model.</span>
<span class="sd">    Transform the image which includes resizing, centercrop and normalize.</span>
<span class="sd">    Args:</span>
<span class="sd">        image_bytes: Input image in bytes</span>
<span class="sd">    Returns:</span>
<span class="sd">        Tensor</span>
<span class="sd">    Raises:</span>
<span class="sd">        Except: An error occurred accessing the bytes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">transformations</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="c1"># Resnet needed 224  image</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">CenterCrop</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">[</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span> <span class="n">std</span><span class="o">=</span><span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">])])</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">image_bytes</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">transformations</span><span class="p">(</span><span class="n">image</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#converted image into batch size of 1</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">raise</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">imagenet1000_classidx_to_label</span><span class="p">(</span><span class="n">class_idx</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Convert class index to class labels, Imagenet.</span>
<span class="sd">    Converting predicted class index to class labels, Imagenet.</span>
<span class="sd">    Args:</span>
<span class="sd">        class_idx: str, predicted class index.</span>
<span class="sd">    Returns:</span>
<span class="sd">        A dict mapping keys to the corresponding table row data</span>
<span class="sd">        fetched. Each row is represented as a tuple of strings.</span>
<span class="sd">        Returned keys are always bytes.  If a key from the keys argument is</span>
<span class="sd">        missing from the dictionary, then that row was not found in the</span>
<span class="sd">        table (and require_all_keys must have been False).</span>
<span class="sd">    Raises:</span>
<span class="sd">        Exception: An error occurred accessing the json file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1">#content_object = s3.Object(S3_BUCKET,json_data)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Entered into Class prediction level&#39;</span><span class="p">)</span>
        <span class="n">content_object</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="n">S3_BUCKET</span><span class="p">)</span><span class="o">.</span><span class="n">Object</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
        <span class="n">file_content</span> <span class="o">=</span> <span class="n">content_object</span><span class="o">.</span><span class="n">get</span><span class="p">()[</span><span class="s1">&#39;Body&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">json_content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">json_content</span><span class="p">[</span><span class="n">class_idx</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;Class Not Found&quot;</span>

<span class="k">def</span> <span class="nf">get_prediction</span><span class="p">(</span><span class="n">image_bytes</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Prediction from pre-trained model.</span>
<span class="sd">    Inferecing using pre-trained model</span>
<span class="sd">    Args:</span>
<span class="sd">        image_bytes: Transformed image_bytes</span>
<span class="sd">    Returns:</span>
<span class="sd">        int, predicted class index from imagenet</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tensor</span> <span class="o">=</span> <span class="n">transform_image</span><span class="p">(</span><span class="n">image_bytes</span><span class="o">=</span><span class="n">image_bytes</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">classify_image</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Classify image using api.</span>
<span class="sd">    Function is called from this template python: handler.py</span>
<span class="sd">    Args:</span>
<span class="sd">        event: Dictionary containing API inputs </span>
<span class="sd">        context: Dictionary</span>
<span class="sd">    Returns:</span>
<span class="sd">        dictionary: API response</span>
<span class="sd">    Raises:</span>
<span class="sd">        Exception: Returning API repsonse 500</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Entering into event&quot;</span><span class="p">)</span>
        <span class="n">content_type_header</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;headers&#39;</span><span class="p">][</span><span class="s1">&#39;content-type&#39;</span><span class="p">]</span>
        <span class="c1">#print(event[&#39;body&#39;]) #printing the actual image in hex format</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">])</span> <span class="c1">#decoding the base64 image</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Body loaded&quot;</span><span class="p">)</span>

        <span class="n">picture</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">MultipartDecoder</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">content_type_header</span><span class="p">)</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="n">get_prediction</span><span class="p">(</span><span class="n">image_bytes</span><span class="o">=</span><span class="n">picture</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>

        <span class="n">prediction_label</span> <span class="o">=</span> <span class="n">imagenet1000_classidx_to_label</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">prediction</span><span class="p">))</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">picture</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">picture</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">{</span> <span class="c1">#returning the result for the event</span>
            <span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
            <span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">:</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span>
                <span class="s2">&quot;Access-Control-Allow-Credentials&quot;</span><span class="p">:</span> <span class="kc">True</span>
                <span class="p">},</span>
            <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span><span class="s1">&#39;predicted&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prediction</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">prediction_label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span>
    <span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
            <span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">:</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span>
                <span class="s2">&quot;Access-Control-Allow-Credentials&quot;</span><span class="p">:</span> <span class="kc">True</span>
            <span class="p">},</span>
            <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
        <span class="p">}</span>
</pre></div>


<p><em>The above codeblock define as the entry handler function for Lambda. It contains application specific code. Following functions are implemented in this file:</em></p>
<p><code>1. S3 bucket and path for model file in S3.</code></p>
<p><code>2. Loading of the model and JSON from S3 bucket.</code></p>
<p><code>3. Entry handler functions which will be invoke every time AWS Lanbda function is triggered.</code></p>
<p><code>4. Processing of incoming image content and using model for image's classification.</code></p>
<ul>
<li><em>Update configurations in serverless.yml</em></li>
</ul>
<div class="highlight"><pre><span></span><span class="n">service</span><span class="o">:</span> <span class="n">mobilenet</span><span class="o">-</span><span class="n">v2</span>

<span class="n">provider</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">aws</span>
  <span class="n">runtime</span><span class="o">:</span> <span class="n">python3</span><span class="o">.</span><span class="mi">8</span>
  <span class="n">stage</span><span class="o">:</span> <span class="n">dev</span>
  <span class="n">region</span><span class="o">:</span> <span class="n">ap</span><span class="o">-</span><span class="n">south</span><span class="o">-</span><span class="mi">1</span>
  <span class="n">timeout</span><span class="o">:</span> <span class="mi">60</span>
  <span class="n">environment</span><span class="o">:</span>
    <span class="n">S3_BUCKET</span><span class="o">:</span> <span class="n">s3</span><span class="o">-</span><span class="n">bucket</span><span class="o">-</span><span class="n">name</span>
    <span class="n">MODEL_PATH</span><span class="o">:</span> <span class="n">mobilenet_v2</span><span class="o">.</span><span class="na">pt</span>
  <span class="n">iamRoleStatements</span><span class="o">:</span>
    <span class="o">-</span> <span class="n">Effect</span><span class="o">:</span> <span class="s2">&quot;Allow&quot;</span>
      <span class="n">Action</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">s3</span><span class="o">:</span><span class="n">getObject</span>
      <span class="n">Resource</span><span class="o">:</span> <span class="n">arn</span><span class="o">:</span><span class="n">aws</span><span class="o">:</span><span class="n">s3</span><span class="o">:::</span><span class="n">s3</span><span class="o">-</span><span class="n">bucket</span><span class="o">-</span><span class="n">name</span><span class="o">/*</span>

<span class="n">custom</span><span class="o">:</span>
  <span class="n">pythonRequirements</span><span class="o">:</span>
    <span class="n">dockerizePip</span><span class="o">:</span> <span class="kc">true</span>
    <span class="n">zip</span><span class="o">:</span> <span class="kc">true</span>
    <span class="n">slim</span><span class="o">:</span> <span class="kc">true</span>
    <span class="n">strip</span><span class="o">:</span> <span class="kc">false</span>
    <span class="n">noDeploy</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">docutils</span>
      <span class="o">-</span> <span class="n">jmespath</span>
      <span class="o">-</span> <span class="n">pip</span>
      <span class="o">-</span> <span class="n">python</span><span class="o">-</span><span class="n">dateutil</span>
      <span class="o">-</span> <span class="n">setuptools</span>
      <span class="o">-</span> <span class="n">six</span>
      <span class="o">-</span> <span class="n">tensorboard</span>
    <span class="n">useStaticCache</span><span class="o">:</span> <span class="kc">true</span>
    <span class="n">useDownloadCache</span><span class="o">:</span> <span class="kc">true</span>
    <span class="n">cacheLocation</span><span class="o">:</span> <span class="s2">&quot;./cache&quot;</span>

<span class="kd">package</span><span class="o">:</span>
  <span class="n">individually</span><span class="o">:</span> <span class="kc">false</span>
  <span class="n">exclude</span><span class="o">:</span>
    <span class="o">-</span> <span class="kd">package</span><span class="o">.</span><span class="na">json</span>
    <span class="o">-</span> <span class="kd">package</span><span class="o">-</span><span class="n">log</span><span class="o">.</span><span class="na">json</span>
    <span class="o">-</span> <span class="n">node_modules</span><span class="o">/**</span>
    <span class="o">-</span> <span class="n">cache</span><span class="o">/**</span>
    <span class="o">-</span> <span class="n">test</span><span class="o">/**</span>
    <span class="o">-</span> <span class="n">__pycache__</span><span class="o">/**</span>
    <span class="o">-</span> <span class="o">.</span><span class="na">pytest_cache</span><span class="o">/**</span>
    <span class="o">-</span> <span class="n">model</span><span class="o">/**</span>

<span class="n">functions</span><span class="o">:</span>
  <span class="n">classify_image</span><span class="o">:</span>
    <span class="n">handler</span><span class="o">:</span> <span class="n">handler</span><span class="o">.</span><span class="na">classify_image</span>
    <span class="n">memorySize</span><span class="o">:</span> <span class="mi">3008</span>
    <span class="n">timeout</span><span class="o">:</span> <span class="mi">60</span>
    <span class="n">events</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">http</span><span class="o">:</span>
          <span class="n">path</span><span class="o">:</span> <span class="n">mobilenetV2</span><span class="o">-</span><span class="n">classify</span>
          <span class="n">method</span><span class="o">:</span> <span class="n">post</span>
          <span class="n">cors</span><span class="o">:</span> <span class="kc">true</span>

<span class="n">plugins</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">serverless</span><span class="o">-</span><span class="n">python</span><span class="o">-</span><span class="n">requirements</span>
</pre></div>


<ul>
<li>Deploy the package</li>
</ul>
<div class="highlight"><pre><span></span><span class="err">sudo serverless deploy</span>
</pre></div>


<p align = 'center'>
    <img src = "images/output.png" alt="Deployment" />
</p>

<p><em><code>After running deployment command, it will check the size of zip files if the size is less than 250 mb then it will generated API end point and it creates all the necessary AWS resources for running the application. Restful API end point is created on AWS API gateway.</code></em></p>
<ul>
<li>API gateway configuration for Binary Media Type</li>
</ul>
<p><strong>We need to allow multipart/form-data content type for the HTTP request and hence visit AWS API gateway console and set "Binary Media Type" as "multipart/form-data"</strong></p>
<ul>
<li>Testing Deploying using API tool</li>
</ul>
<p>Install <a href="https://insomnia.rest/download/">Insomnia</a> API tool is used to test the deployment. Invoke API with following configurations:</p>
<div class="highlight"><pre><span></span>    <span class="n">HTTP</span> <span class="k">Method</span><span class="p">:</span> <span class="n">POST</span>

    <span class="n">URL</span><span class="p">:</span> <span class="err">{</span><span class="k">generated</span> <span class="n">API</span> <span class="n">link</span> <span class="k">after</span> <span class="n">deployment</span><span class="err">}</span>

    <span class="n">Content</span><span class="o">-</span><span class="k">Type</span><span class="p">:</span> <span class="n">multipart</span><span class="o">/</span><span class="n">form</span><span class="o">-</span><span class="k">data</span>

    <span class="k">Select</span> <span class="n">image</span> <span class="n">file</span> <span class="k">for</span> <span class="n">clasification</span><span class="p">:</span> <span class="n">dog</span><span class="p">.</span><span class="n">jpg</span>
</pre></div>


<p align = 'center'>
    <img src = "images/output1.png" alt="output" />
</p>

<p><em>If you have any doubts in the article, feel free to comment on your queries. I will be more than happy to help. I am also open to suggestions and feedbacks.Happy learning!!!</em></p>
<div id="disqus_thread"></div>

<script>
    /**
    *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */

    var disqus_config = function () {
    this.page.url = 'deploying-pretrained-mobilenet-v2-model-over-aws-using-serverless-open-source-framework.html';  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE1; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };

    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://vijayprakashk.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

<div class="highlight"><pre><span></span>
</pre></div>

</article>
            </div>
        </div>

        <!-- Sidebar -->
        <div id="sidebar">

            <!-- Avatar -->

            <!-- Logo -->
            <h1 id="logo"><img id="avatar" alt="Avatar" src="https://user-images.githubusercontent.com/42317258/91530727-3c21cb00-e929-11ea-9691-21088dd85801.png"/><a href="./">VIJAY PRAKASH</a></h1>

            <!-- Nav -->
            <nav id="nav">
                <ul>
                    <li class="current"><a href="./category/eva.html">EVA</a></li>
                    <li><a href="./pages/about.html">About</a></li>
                </ul>
            </nav>

            <!-- Search -->
            <!--
            <section class="box search">
                <form method="post" action="#">
                    <input type="text" class="text" name="search" placeholder="Search" />
                </form>
            </section>
            -->
            <!-- Tags -->
            <section class="box text-style1">
                <div class="inner">
                    <header>
                        <h2>Tags:</h2>
                    </header>
                        <a class="tag-4" href="./tag/imagenet.html">Imagenet</a>
                        <a class="tag-4" href="./tag/classification.html">classification</a>
                        <a class="tag-4" href="./tag/aws-lambda.html">Aws lambda</a>
                        <a class="tag-4" href="./tag/mobilenet-v2.html">mobilenet v2</a>
                </div>
            </section>

            <!-- Recent Posts -->
            <!--
            <section class="box recent-posts">
                <header>
                    <h2>Recent Posts</h2>
                </header>
                <ul>
                    <li><a href="#">Lorem ipsum dolor</a></li>
                    <li><a href="#">Feugiat nisl aliquam</a></li>
                    <li><a href="#">Sed dolore magna</a></li>
                    <li><a href="#">Malesuada commodo</a></li>
                    <li><a href="#">Ipsum metus nullam</a></li>
                </ul>
            </section>
            -->

            <!-- Recent Comments -->
            <!--
            <section class="box recent-comments">
                <header>
                    <h2>Recent Comments</h2>
                </header>
                <ul>
                    <li>case on <a href="#">Lorem ipsum dolor</a></li>
                    <li>molly on <a href="#">Sed dolore magna</a></li>
                    <li>case on <a href="#">Sed dolore magna</a></li>
                </ul>
            </section>
            -->

            <!-- Calendar -->
            <!--
            <section class="box calendar">
                <div class="inner">
                    <table>
                        <caption>August 2020</caption>
                        <thead>
                            <tr>
                                <th scope="col" title="Monday">M</th>
                                <th scope="col" title="Tuesday">T</th>
                                <th scope="col" title="Wednesday">W</th>
                                <th scope="col" title="Thursday">T</th>
                                <th scope="col" title="Friday">F</th>
                                <th scope="col" title="Saturday">S</th>
                                <th scope="col" title="Sunday">S</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="4" class="pad"><span>&nbsp;</span></td>
                                <td><span>1</span></td>
                                <td><span>2</span></td>
                                <td><span>3</span></td>
                            </tr>
                            <tr>
                                <td><span>4</span></td>
                                <td><span>5</span></td>
                                <td><a href="#">6</a></td>
                                <td><span>7</span></td>
                                <td><span>8</span></td>
                                <td><span>9</span></td>
                                <td><a href="#">10</a></td>
                            </tr>
                            <tr>
                                <td><span>11</span></td>
                                <td><span>12</span></td>
                                <td><span>13</span></td>
                                <td><span>14</span></td>
                                <td><span>15</span></td>
                                <td><span>16</span></td>
                                <td><span>17</span></td>
                            </tr>
                            <tr>
                                <td><span>18</span></td>
                                <td><span>19</span></td>
                                <td><span>20</span></td>
                                <td><span>21</span></td>
                                <td><span>22</span></td>
                                <td><a href="#">23</a></td>
                                <td><span>24</span></td>
                            </tr>
                            <tr>
                                <td><a href="#">25</a></td>
                                <td><span>26</span></td>
                                <td><span>27</span></td>
                                <td><span>28</span></td>
				<td><span>29</span></td>
				<td class="today"><a href="#">30</a></td>
                                <td class="pad" colspan="3"><span>&nbsp;</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
            -->

            <!-- Blogroll Links -->
            <section class="box blogroll">
                <header>
                    <h2>Links</h2>
                </header>
                <ul>
                    <li><a href="https://theschoolof.ai/">The School of AI</a></li>
                    <li><a href="https://github.com/VijayPrakashReddy-k/Extensive-Vision-AI/tree/master/Phase%202">Code reference</a></li>
                </ul>
            </section>

            <!-- Social Links -->
            <section class="box social-links">
                <header>
                    <h2>Social</h2>
                </header>
                <ul>

                    <li><i class="fa fa-github-square"></i> <a href="https://github.com/VijayPrakashReddy-k">github</a></li>
                    <li><i class="fa fa-twitter-square"></i> <a href="https://twitter.com/K_VijayPrakash">twitter</a></li>
                    <li><i class="fa fa-linkedin-square"></i> <a href="https://www.linkedin.com/in/vijayprakash-reddy-kovuru-ab3740166/">linkedin</a></li>
                </ul>
            </section>

            <!-- Copyright -->
            <ul id="copyright">
                <li>&copy; </li>
                <li>Powered by <a href="http://getpelican.com/">Pelican</a></li>
                <li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
            </ul>

        </div>

        <!-- Scripts -->
        <script src="./theme/assets/js/jquery.min.js"></script>
        <script src="./theme/assets/js/skel.min.js"></script>
        <script src="./theme/assets/js/util.js"></script>
        <!--[if lte IE 8]><script src="./theme/assets/js/ie/respond.min.js"></script><![endif]-->
        <script src="./theme/assets/js/main.js"></script>
<script>
$("article img").each(function() {
  $(this).load(function() {
    var imgWidth = $(this).width();
    var imgHeight = $(this).height();
    if (imgHeight > imgWidth) {
      $(this).css({
        "width": "60%",
        "margin": "0 auto"
      });
    }
    var imageCaption = $(this).attr("alt");
    if (imageCaption != '') {
      // display image caption on top of image
      imgWidth = imgWidth - 5;
      var positionTop = imgHeight - 26;
      $("<span class='img-caption'>" + imageCaption + "</span>").css({
          "top": positionTop + "px",
          "width": imgWidth + "px"
      }).insertAfter(this);
    }
  });
  if (this.complete) $(this).trigger("load");
});
</script>

	<div id="disqus_thread"></div>
	<script>

	/**
	*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
	*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/

	var disqus_config = function () {
	this.page.url = 127.0.0.1:8000/deploying-pretrained-mobilenet-v2-model-over-aws-using-serverless-open-source-framework.html  // Replace PAGE_URL with your page's canonical URL variable
	this.page.identifier = PAGE1; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
	};

	(function() { // DON'T EDIT BELOW THIS LINE
	var d = document, s = d.createElement('script');
	s.src = 'https://vijayprakashk.disqus.com/embed.js';
	s.setAttribute('data-timestamp', +new Date());
	(d.head || d.body).appendChild(s);
	})();
	</script>
	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    </body>
</html>